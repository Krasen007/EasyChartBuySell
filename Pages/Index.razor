@page "/"
@inject HttpClient Http
@using EasyChartBuySell
@using Microsoft.AspNetCore.Components.WebAssembly
@using Plotly.Blazor
@using Plotly.Blazor.LayoutLib
@using Plotly.Blazor.LayoutLib.XAxisLib
@using Plotly.Blazor.Traces.CandlestickLib
@using Plotly.Blazor.Traces.ScatterLib
@using Line = Plotly.Blazor.Traces.CandlestickLib.DecreasingLib.Line

<h1>Hello, world!</h1>

Welcome to your new app.

<PlotlyChart style="height: 60vh; min-height: 350px" @bind-Config="config" @bind-Layout="layout" @bind-Data="data" @ref="chart" />

<div class="text-right">
    <button type="button" class="btn btn-primary" @onclick="() => chart.Clear()">Clear</button>
    @* <button type="button" class="btn btn-primary" @onclick="() => DeleteScatter()">Pop</button> *@
    <button type="button" class="btn btn-primary" @onclick="() => AddNewData()">Add New Data</button>
    @*<button type="button" class="btn btn-primary" @onclick="() => Restyle()">Rename First</button>
    <button type="button" class="btn btn-primary" @onclick="() => PrependData()">Prepend First</button> *@
    @* <button type="button" class="btn btn-primary" @onclick="() => ExtendData()">Extend Data</button> *@
    @* <button type="button" class="btn btn-primary" @onclick="() => PrependWithLimit()">Prepend First (Max. 100)</button>
    <button type="button" class="btn btn-primary" @onclick="() => ExtendWithLimit()">Extend First (Max. 100)</button> *@
</div>

@* <button type="button" class="btn btn-primary" @onclick="() => CurrPrice()">Price check</button>
Check the ... CurrPrice(); *@

@code
{
    public string news = "";

    PlotlyChart chart;

    Config config = new Config
    {
        Responsive = true
    };

    Layout layout = new Layout
    {
        Title = new Plotly.Blazor.LayoutLib.Title
        {
            Text = "Scatter"
        },
        YAxis = new List<YAxis>
        {
            new YAxis
            {
                Title = new Plotly.Blazor.LayoutLib.YAxisLib.Title
                {
                    Text = "Scatter Unit"
                }
            }
        }
    };

    IList<ITrace> data = new List<ITrace>{
        new Scatter
        {
            Name = "ScatterTrace",
            Mode = ModeFlag.Lines | ModeFlag.Markers,   
            X = new List<object>(), 
            Y = new List<object>()
        }
    };

    private string CurrPrice(string currentPrice) {
        return currentPrice;
    }

    private async Task ExtendData(int count = 100)
    {
        if (!(chart.Data.FirstOrDefault() is Scatter scatter)) return;
        
        var parsedData = await Http.GetStringAsync("Data/eth.txt");      

        List<string> dataList = parsedData.Split(new[] { "\r\n" }, StringSplitOptions.None)
                             .ToList();
        
        CurrPrice(dataList[dataList.Count]);

        var x = new List<object>();
        var y = new List<object>();

        foreach (var item in dataList)
        {
            y.Add(item);
        }      

        var startDate = new DateTime(2021, 5, 14, 18, 0, 0);
        var time = 0;
        for (int i = 0; i < dataList.Count; i++)
        {
            x.Add(startDate);
            startDate = startDate.AddHours(1);
            time++;
            if (time == 24)
            {
                time = 0;
            }
        }     

        if (!scatter.X.Any() || !scatter.Y.Any())
        {
            scatter.X.AddRange(x);
            scatter.Y.AddRange(y);
            await chart.React();
        }
        else
        {
            await chart.ExtendTrace(x, y, data.IndexOf(scatter));
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ExtendData();
        }
    }

    private async Task AddNewData()
    {
        @* var (x, y) = Helper.GenerateData(0,100); *@
        var x = new List<object>();
        var y = new List<object>();

        y.Add(320);
        y.Add(370);
        y.Add(389);
        y.Add(370);
        y.Add(355);
        y.Add(380);

        x.Add(new DateTime(2021, 5, 17));
        x.Add(new DateTime(2021, 5, 18));
        x.Add(new DateTime(2021, 5, 19));
        x.Add(new DateTime(2021, 5, 20));
        x.Add(new DateTime(2021, 5, 21));
        x.Add(new DateTime(2021, 5, 22));

        await chart.AddTrace(new Scatter
        {

            Name = $"ScatterTrace{data.Count+1}",
            Mode = ModeFlag.Lines | ModeFlag.Markers,
            X = x,
            Y = y
        });
    }
}